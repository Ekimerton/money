#!/usr/bin/env bash
set -euo pipefail

# This script is for initializing your money server

# Setting up node
# TODO

# Setting up pm2
# TODO

# Setting up python

# Ensure we are in the project root (directory of this script)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Locate Python (prefer python3)
PYTHON_BIN=""
if command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
else
  echo "Error: Python 3 is not installed. Please install Python 3 and retry." >&2
  exit 1
fi

# Verify pip for the chosen Python, bootstrap if possible
if ! "$PYTHON_BIN" -m pip --version >/dev/null 2>&1; then
  echo "pip not found for $PYTHON_BIN; attempting to bootstrap with ensurepip..."
  if "$PYTHON_BIN" -m ensurepip --upgrade >/dev/null 2>&1; then
    echo "pip bootstrapped successfully."
  else
    echo "Error: pip is unavailable and could not be bootstrapped. Please install pip." >&2
    exit 1
  fi
fi

# Create virtual environment in data/.venv
VENV_DIR="$SCRIPT_DIR/data/.venv"
mkdir -p "$SCRIPT_DIR/data"
# Initialize user settings file if missing
USER_SETTINGS_FILE="$SCRIPT_DIR/data/user-settings.json"
if [ ! -f "$USER_SETTINGS_FILE" ]; then
  echo "Creating default user settings at $USER_SETTINGS_FILE ..."
  cat > "$USER_SETTINGS_FILE" <<'EOF'
{
  "geminiApiKey": ""
}
EOF
else
  echo "User settings already present at $USER_SETTINGS_FILE"
fi
if [ ! -d "$VENV_DIR" ]; then
  echo "Creating virtual environment at $VENV_DIR ..."
  "$PYTHON_BIN" -m venv "$VENV_DIR"
else
  echo "Virtual environment already exists at $VENV_DIR"
fi

VENV_PYTHON="$VENV_DIR/bin/python"
if [ ! -x "$VENV_PYTHON" ]; then
  echo "Error: Expected venv Python at $VENV_PYTHON but it was not found or not executable." >&2
  exit 1
fi

echo "Upgrading pip, setuptools, and wheel inside the virtual environment..."
"$VENV_PYTHON" -m pip install --upgrade pip setuptools wheel

# Install requirements
REQ_FILE="$SCRIPT_DIR/data/requirements.txt"
if [ ! -f "$REQ_FILE" ]; then
  echo "Error: Requirements file not found at $REQ_FILE" >&2
  exit 1
fi

echo "Installing dependencies from $REQ_FILE ..."
"$VENV_PYTHON" -m pip install -r "$REQ_FILE"

echo "Python environment setup complete. Activate with: source \"$VENV_DIR/bin/activate\""
